{% extends 'admin/layout.html' %}

{% block title %}Admin - Chi tiết đơn thuê{% endblock %}

{% block page_content %}
<div class="content-page">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <h4 class="card-title">Chi tiết đơn thuê #{{ rental.id }}</h4>
            <a href="{{ url_for('admin.rentals') }}" class="btn btn-secondary">
              <i class="las la-arrow-left"></i> Quay lại
            </a>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5>Thông tin đơn thuê</h5>
                <table class="table table-bordered">
                  <tr>
                    <th width="40%">Mã đơn:</th>
                    <td><strong>#{{ rental.id }}</strong></td>
                  </tr>
                  <tr>
                    <th>Trạng thái:</th>
                    <td>
                      {% if rental.status == 'pending' %}
                        <span class="badge badge-warning">Chờ xác nhận</span>
                      {% elif rental.status == 'confirmed' %}
                        <span class="badge badge-info">Đã xác nhận</span>
                      {% elif rental.status == 'rented' %}
                        <span class="badge badge-primary">Đang thuê</span>
                      {% elif rental.status == 'returned' %}
                        <span class="badge badge-success">Đã trả</span>
                      {% elif rental.status == 'cancelled' %}
                        <span class="badge badge-danger">Đã hủy</span>
                      {% else %}
                        <span class="badge badge-secondary">{{ rental.status or '-' }}</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Ngày bắt đầu:</th>
                    <td>{{ rental.start_date.strftime('%d/%m/%Y %H:%M') if rental.start_date else '-' }}</td>
                  </tr>
                  <tr>
                    <th>Ngày kết thúc:</th>
                    <td>{{ rental.end_date.strftime('%d/%m/%Y %H:%M') if rental.end_date else '-' }}</td>
                  </tr>
                  <tr>
                    <th>Ngày trả thực tế:</th>
                    <td>{{ rental.actual_return_date.strftime('%d/%m/%Y %H:%M') if rental.actual_return_date else '-' }}</td>
                  </tr>
                  <tr>
                    <th>Số ngày thuê:</th>
                    <td>{{ rental.rental_days or '-' }} ngày</td>
                  </tr>
                  <tr>
                    <th>Số lượng xe:</th>
                    <td><strong>{{ rental.quantity or assigned_motorcycles_count or '0' }} xe</strong></td>
                  </tr>
                  <tr>
                    <th>Tổng tiền:</th>
                    <td><strong>{{ "{:,.0f}".format(rental.total_amount) if rental.total_amount else '0' }} VND</strong></td>
                  </tr>
                  <tr>
                    <th>Tiền đặt cọc:</th>
                    <td>{{ "{:,.0f}".format(rental.deposit_amount) if rental.deposit_amount else '0' }} VND</td>
                  </tr>
                  <tr>
                    <th>Đã thanh toán:</th>
                    <td><strong class="text-success">{{ "{:,.0f}".format(rental.paid_amount) if rental.paid_amount else '0' }} VND</strong></td>
                  </tr>
                  <tr>
                    <th>Phương thức thanh toán:</th>
                    <td>{{ rental.payment_method or '-' }}</td>
                  </tr>
                  <tr>
                    <th>Trạng thái thanh toán:</th>
                    <td>
                      {% if rental.payment_status == 'paid' %}
                        <span class="badge badge-success">Đã thanh toán</span>
                      {% elif rental.payment_status == 'pending' %}
                        <span class="badge badge-warning">Chờ thanh toán</span>
                      {% elif rental.payment_status == 'failed' %}
                        <span class="badge badge-danger">Thất bại</span>
                      {% else %}
                        <span class="badge badge-secondary">{{ rental.payment_status or '-' }}</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Mã giao dịch VNPay:</th>
                    <td>{{ rental.vnpay_transaction_id or '-' }}</td>
                  </tr>
                  <tr>
                    <th>Ghi chú:</th>
                    <td>{{ rental.notes or '-' }}</td>
                  </tr>
                </table>
              </div>
              <div class="col-md-6">
                <h5>Thông tin khách hàng</h5>
                {% if customer %}
                <table class="table table-bordered">
                  <tr>
                    <th width="40%">Họ và tên:</th>
                    <td><strong>{{ customer.full_name }}</strong></td>
                  </tr>
                  <tr>
                    <th>Số điện thoại:</th>
                    <td>{{ customer.phone or '-' }}</td>
                  </tr>
                  <tr>
                    <th>Email:</th>
                    <td>{{ customer.email or '-' }}</td>
                  </tr>
                  <tr>
                    <th>CCCD/CMND:</th>
                    <td>{{ customer.citizen_id or '-' }}</td>
                  </tr>
                  <tr>
                    <th>Địa chỉ:</th>
                    <td>{{ customer.address or '-' }}</td>
                  </tr>
                </table>
                <a href="{{ url_for('admin.customer_detail', customer_id=customer.id) }}" class="btn btn-sm btn-primary">
                  <i class="las la-user"></i> Xem chi tiết khách hàng
                </a>
                {% else %}
                <p class="text-muted">Không có thông tin khách hàng</p>
                {% endif %}
              </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Chi tiết xe thuê ({{ items|length }})</h5>
              <button class="btn btn-primary" onclick="openAssignMotorcyclesModal()">
                <i class="las la-plus"></i> Gán xe cho đơn thuê
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>STT</th>
                    <th>Biển số xe</th>
                    <th>Loại xe</th>
                    <th>Tình trạng</th>
                    <th>Giá/ngày</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  {% if items %}
                    {% set assigned_items = items|selectattr('motorcycle_id')|list %}
                    {% if assigned_items|length > 0 %}
                      {% for item in assigned_items %}
                      <tr>
                        <td>{{ loop.index }}</td>
                        <td><strong>{{ item.motorcycle.license_plate }}</strong></td>
                        <td>{{ item.motorcycle.category.name if item.motorcycle.category else '-' }}</td>
                        <td>
                          {% if item.motorcycle.status == 'ready' %}
                            <span class="badge badge-success">Sẵn sàng</span>
                          {% elif item.motorcycle.status == 'rented' %}
                            <span class="badge badge-warning">Đang thuê</span>
                          {% elif item.motorcycle.status == 'maintenance' %}
                            <span class="badge badge-danger">Bảo trì</span>
                          {% else %}
                            <span class="badge badge-secondary">{{ item.motorcycle.status or '-' }}</span>
                          {% endif %}
                        </td>
                        <td>{{ "{:,.0f}".format(item.price_per_day) if item.price_per_day else '0' }} VND</td>
                        <td>
                          <button class="btn btn-sm btn-danger" onclick="removeMotorcycle({{ item.id }})">
                            <i class="las la-trash"></i> Xóa
                          </button>
                        </td>
                      </tr>
                      {% endfor %}
                    {% else %}
                    <tr>
                      <td colspan="6" class="text-center text-muted">
                        <i class="las la-info-circle"></i> Chưa có xe nào được gán. Vui lòng gán xe cho đơn thuê.
                      </td>
                    </tr>
                    {% endif %}
                  {% else %}
                    <tr>
                      <td colspan="6" class="text-center text-muted">
                        <i class="las la-info-circle"></i> Không có chi tiết
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <h5>Lịch sử thanh toán ({{ payments|length }})</h5>
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Mã giao dịch</th>
                    <th>Số tiền</th>
                    <th>Phương thức</th>
                    <th>Trạng thái</th>
                    <th>Mã VNPay</th>
                    <th>Ngày thanh toán</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  {% if payments %}
                    {% for payment in payments %}
                    <tr>
                      <td>{{ payment.payment_code or '-' }}</td>
                      <td><strong>{{ "{:,.0f}".format(payment.amount) if payment.amount else '0' }} VND</strong></td>
                      <td>{{ payment.payment_method or '-' }}</td>
                      <td>
                        {% if payment.payment_status == 'paid' %}
                          <span class="badge badge-success">Đã thanh toán</span>
                        {% elif payment.payment_status == 'pending' %}
                          <span class="badge badge-warning">Chờ thanh toán</span>
                        {% elif payment.payment_status == 'failed' %}
                          <span class="badge badge-danger">Thất bại</span>
                        {% else %}
                          <span class="badge badge-secondary">{{ payment.payment_status or '-' }}</span>
                        {% endif %}
                      </td>
                      <td>{{ payment.vnpay_transaction_id or '-' }}</td>
                      <td>{{ payment.payment_date.strftime('%d/%m/%Y %H:%M') if payment.payment_date else '-' }}</td>
                      <td>
                        <a href="{{ url_for('admin.payment_detail', payment_id=payment.id) }}" class="btn btn-sm btn-primary">
                          <i class="las la-eye"></i> Chi tiết
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="7" class="text-center">Chưa có giao dịch thanh toán</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <hr>

            <!-- Phần thanh toán và trả xe -->
            {% if rental.status in ['confirmed', 'rented'] %}
            <div class="card mt-3">
              <div class="card-header">
                <h5 class="mb-0">Thanh toán và trả xe</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="actualReturnDate">Ngày trả thực tế:</label>
                      <input type="datetime-local" class="form-control" id="actualReturnDate" 
                             value="{% if rental.actual_return_date %}{{ rental.actual_return_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                             style="max-width: 300px;">
                      <small class="form-text text-muted">Chọn ngày và giờ trả xe thực tế</small>
                    </div>
                    <button type="button" class="btn btn-info mb-3" onclick="calculateRemainingAmount()">
                      <i class="las la-calculator"></i> Tính toán số tiền
                    </button>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="alert alert-info">
                      <h6>Thông tin thanh toán:</h6>
                      <div class="row">
                        <div class="col-md-3">
                          <p class="mb-1"><strong>Tổng tiền:</strong></p>
                          <p class="mb-0"><span id="totalAmount">{{ "{:,.0f}".format(rental.total_amount) if rental.total_amount else '0' }}</span> VND</p>
                        </div>
                        <div class="col-md-3">
                          <p class="mb-1"><strong>Đã thanh toán:</strong></p>
                          <p class="mb-0 text-success"><span id="paidAmount">{{ "{:,.0f}".format(rental.paid_amount) if rental.paid_amount else '0' }}</span> VND</p>
                        </div>
                        <div class="col-md-3">
                          <p class="mb-1"><strong>Số ngày thuê thực tế:</strong></p>
                          <p class="mb-0"><span id="actualDays">-</span> ngày</p>
                        </div>
                        <div class="col-md-3">
                          <p class="mb-1"><strong>Số xe đã gán:</strong></p>
                          <p class="mb-0"><span id="totalMotorcycles">{{ assigned_motorcycles_count }}</span> xe</p>
                        </div>
                      </div>
                      <hr>
                      <div class="row">
                        <div class="col-md-12">
                          <p class="mb-1"><strong class="text-danger">Số tiền còn lại phải thanh toán:</strong></p>
                          <h3 class="text-danger mb-0" id="remainingAmount">0 VND</h3>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <hr>
                <div class="row">
                  <div class="col-md-12">
                    <h6>Phương thức thanh toán:</h6>
                    <div class="form-group">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMethodCash" value="cash" checked>
                        <label class="form-check-label" for="paymentMethodCash">
                          <i class="las la-money-bill-wave"></i> Tiền mặt
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMethodVNPay" value="vnpay">
                        <label class="form-check-label" for="paymentMethodVNPay">
                          <i class="las la-credit-card"></i> VNPay
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-success btn-lg" onclick="processPayment()" id="processPaymentBtn">
                      <i class="las la-check-circle"></i> Xác nhận thanh toán và trả xe
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Gán xe -->
<div class="modal fade" id="assignMotorcyclesModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gán xe cho đơn thuê #{{ rental.id }}</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="assignMotorcyclesContent">
          <p class="text-center">Đang tải danh sách xe...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary" onclick="saveMotorcycleAssignments()">Lưu</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Chọn xe cho từng item -->
<div class="modal fade" id="assignSingleMotorcycleModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chọn xe</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="currentRentalItemId">
        <div class="form-group">
          <label>Chọn xe:</label>
          <select class="form-control" id="motorcycleSelect">
            <option value="">-- Chọn xe --</option>
            {% if available_motorcycles %}
              {% for mc in available_motorcycles %}
              <option value="{{ mc.id }}" data-status="{{ mc.status }}">
                {{ mc.license_plate }} - {{ mc.category.name if mc.category else '-' }}
                {% if mc.status == 'ready' %}
                  (Sẵn sàng)
                {% elif mc.status == 'rented' %}
                  (Đang thuê)
                {% elif mc.status == 'maintenance' %}
                  (Bảo trì)
                {% endif %}
              </option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveSingleMotorcycleAssignment()">Lưu</button>
      </div>
    </div>
  </div>
</div>

<script>
let motorcycleAssignments = {};

function openAssignMotorcyclesModal() {
  // Load available motorcycles
  fetch('{{ url_for("admin.get_available_motorcycles", rental_id=rental.id) }}')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const items = data.items || [];
        const motorcycles = data.motorcycles || [];
        
        // Get already assigned motorcycle IDs
        const assignedMotorcycleIds = new Set();
        items.forEach(item => {
          if (item.motorcycle_id) {
            assignedMotorcycleIds.add(item.motorcycle_id);
          }
          if (item.motorcycles && item.motorcycles.length > 0) {
            item.motorcycles.forEach(mc => {
              assignedMotorcycleIds.add(mc.id);
            });
          }
        });
        
        let html = '<div class="table-responsive">';
        html += '<table class="table table-bordered table-hover">';
        html += '<thead><tr><th width="50px"><input type="checkbox" id="selectAllMotorcycles"></th><th>Biển số xe</th><th>Loại xe</th><th>Tình trạng</th></tr></thead>';
        html += '<tbody>';
        
        if (motorcycles.length === 0) {
          html += '<tr><td colspan="4" class="text-center text-muted">Không có xe nào trong danh mục này</td></tr>';
        } else {
          motorcycles.forEach(mc => {
            const isChecked = assignedMotorcycleIds.has(mc.id);
            const checkedAttr = isChecked ? 'checked' : '';
            const statusBadge = mc.status === 'ready' ? '<span class="badge badge-success">Sẵn sàng</span>' : 
                                mc.status === 'rented' ? '<span class="badge badge-warning">Đang thuê</span>' : 
                                mc.status === 'maintenance' ? '<span class="badge badge-danger">Bảo trì</span>' : 
                                '<span class="badge badge-secondary">' + (mc.status || '-') + '</span>';
            
            html += '<tr>';
            html += '<td><input type="checkbox" class="motorcycle-checkbox" value="' + mc.id + '" data-license="' + mc.license_plate + '" data-category="' + mc.category_name + '" ' + checkedAttr + '></td>';
            html += '<td><strong>' + mc.license_plate + '</strong></td>';
            html += '<td>' + mc.category_name + '</td>';
            html += '<td>' + statusBadge + '</td>';
            html += '</tr>';
          });
        }
        
        html += '</tbody></table></div>';
        html += '<div class="alert alert-info mt-3">';
        html += '<i class="las la-info-circle"></i> ';
        html += 'Chọn các xe bạn muốn gán cho đơn thuê. Các xe đã được gán sẽ được đánh dấu sẵn.';
        html += '</div>';
        
        document.getElementById('assignMotorcyclesContent').innerHTML = html;
        
        // Add event listener for select all
        const selectAllCheckbox = document.getElementById('selectAllMotorcycles');
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.motorcycle-checkbox').forEach(cb => {
              cb.checked = this.checked;
            });
          });
        }
        
        $('#assignMotorcyclesModal').modal('show');
      } else {
        alert('Lỗi: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Lỗi khi tải danh sách xe!');
    });
}

function assignMotorcycleToItem(itemId) {
  document.getElementById('currentRentalItemId').value = itemId;
  $('#assignSingleMotorcycleModal').modal('show');
}

function saveSingleMotorcycleAssignment() {
  const itemId = document.getElementById('currentRentalItemId').value;
  const motorcycleId = document.getElementById('motorcycleSelect').value;
  
  if (!itemId) {
    alert('Lỗi: Không tìm thấy item!');
    return;
  }
  
  const assignments = [{
    rental_item_id: parseInt(itemId),
    motorcycle_id: motorcycleId ? parseInt(motorcycleId) : null
  }];
  
  fetch('{{ url_for("admin.rental_assign_motorcycles", rental_id=rental.id) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ assignments: assignments })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert('Lỗi: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Lỗi khi lưu!');
  });
}

function saveMotorcycleAssignments() {
  const checkedBoxes = document.querySelectorAll('.motorcycle-checkbox:checked');
  
  if (checkedBoxes.length === 0) {
    alert('Vui lòng chọn ít nhất một xe để gán!');
    return;
  }
  
  // Get all checked motorcycle IDs
  const motorcycleIds = [];
  checkedBoxes.forEach(cb => {
    motorcycleIds.push(parseInt(cb.value));
  });
  
  // Create assignments - rental_item_id can be null, backend will create new items
  const assignments = [{
    rental_item_id: null,
    motorcycle_ids: motorcycleIds
  }];
  
  fetch('{{ url_for("admin.rental_assign_motorcycles", rental_id=rental.id) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ assignments: assignments })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      $('#assignMotorcyclesModal').modal('hide');
      location.reload();
    } else {
      alert('Lỗi: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Lỗi khi lưu!');
  });
}

function removeMotorcycle(itemId) {
  if (!confirm('Bạn có chắc chắn muốn xóa xe này khỏi đơn thuê?')) {
    return;
  }
  
  // Remove motorcycle assignment by setting motorcycle_id to null
  fetch('{{ url_for("admin.rental_assign_motorcycles", rental_id=rental.id) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ 
      assignments: [{
        rental_item_id: itemId,
        motorcycle_ids: []
      }]
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Đã xóa xe khỏi đơn thuê!');
      location.reload();
    } else {
      alert('Lỗi: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Lỗi khi xóa!');
  });
}

function calculateRemainingAmount() {
  const actualReturnDate = document.getElementById('actualReturnDate').value;
  
  if (!actualReturnDate) {
    alert('Vui lòng chọn ngày trả thực tế!');
    return;
  }
  
  const startDate = '{{ rental.start_date.strftime("%Y-%m-%dT%H:%M") if rental.start_date else "" }}';
  if (!startDate) {
    alert('Đơn thuê chưa có ngày bắt đầu!');
    return;
  }
  
  // Send request to calculate
  fetch('{{ url_for("admin.rental_calculate_payment", rental_id=rental.id) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      actual_return_date: actualReturnDate
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('actualDays').textContent = data.actual_days;
      document.getElementById('remainingAmount').textContent = 
        new Intl.NumberFormat('vi-VN').format(data.remaining_amount) + ' VND';
      document.getElementById('totalAmount').textContent = 
        new Intl.NumberFormat('vi-VN').format(data.total_amount) + ' VND';
      document.getElementById('paidAmount').textContent = 
        new Intl.NumberFormat('vi-VN').format(data.paid_amount) + ' VND';
      if (data.total_motorcycles) {
        document.getElementById('totalMotorcycles').textContent = data.total_motorcycles;
      }
      
      // Store calculated data for payment
      window.calculatedPaymentData = {
        actual_return_date: actualReturnDate,
        actual_days: data.actual_days,
        remaining_amount: data.remaining_amount,
        total_amount: data.total_amount
      };
    } else {
      alert('Lỗi: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Lỗi khi tính toán!');
  });
}

function processPayment() {
  if (!window.calculatedPaymentData) {
    alert('Vui lòng tính toán số tiền trước!');
    return;
  }
  
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
  const actualReturnDate = document.getElementById('actualReturnDate').value;
  
  if (!actualReturnDate) {
    alert('Vui lòng chọn ngày trả thực tế!');
    return;
  }
  
  if (!confirm('Bạn có chắc chắn muốn xác nhận thanh toán và trả xe?')) {
    return;
  }
  
  // Disable button
  const btn = document.getElementById('processPaymentBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="las la-spinner la-spin"></i> Đang xử lý...';
  
  fetch('{{ url_for("admin.rental_process_payment", rental_id=rental.id) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      actual_return_date: actualReturnDate,
      payment_method: paymentMethod,
      amount: window.calculatedPaymentData.remaining_amount
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      if (paymentMethod === 'vnpay' && data.payment_url) {
        // Redirect to VNPay
        window.location.href = data.payment_url;
      } else {
        // Cash payment - success
        alert(data.message);
        location.reload();
      }
    } else {
      alert('Lỗi: ' + data.message);
      btn.disabled = false;
      btn.innerHTML = '<i class="las la-check-circle"></i> Xác nhận thanh toán và trả xe';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Lỗi khi xử lý thanh toán!');
    btn.disabled = false;
    btn.innerHTML = '<i class="las la-check-circle"></i> Xác nhận thanh toán và trả xe';
  });
}
</script>
{% endblock %}

